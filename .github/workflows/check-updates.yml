name: Check for Unbound Updates

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:

jobs:
  check-update:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get current Unbound version from main image
        id: current-version
        run: |
          # Pull latest main image if it exists
          if docker pull ghcr.io/${{ github.repository }}:main 2>/dev/null; then
            CURRENT_VERSION=$(docker run --rm --entrypoint sh ghcr.io/${{ github.repository }}:main -c 'apk info unbound 2>/dev/null | grep "^unbound-" | head -1 | cut -d- -f2 | cut -dr -f1')
            echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            echo "Current version in main image: $CURRENT_VERSION"
          else
            echo "current_version=" >> $GITHUB_OUTPUT
            echo "No existing main image found"
          fi

      - name: Check latest Unbound version from Alpine
        id: latest-version
        run: |
          # Use latest Alpine to check available Unbound version
          docker pull alpine:latest
          LATEST_VERSION=$(docker run --rm alpine:latest sh -c 'apk update >/dev/null 2>&1 && apk info unbound 2>/dev/null | grep "^unbound-" | head -1 | cut -d- -f2 | cut -dr -f1')
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "Latest Unbound version in Alpine: $LATEST_VERSION"

      - name: Compare versions
        id: compare
        run: |
          CURRENT="${{ steps.current-version.outputs.current_version }}"
          LATEST="${{ steps.latest-version.outputs.latest_version }}"

          if [ -z "$CURRENT" ]; then
            echo "version_changed=true" >> $GITHUB_OUTPUT
            echo "First build - triggering workflow"
          elif [ "$CURRENT" != "$LATEST" ]; then
            echo "version_changed=true" >> $GITHUB_OUTPUT
            echo "Version changed: $CURRENT -> $LATEST"
          else
            echo "version_changed=false" >> $GITHUB_OUTPUT
            echo "No version change detected"
          fi

      - name: Trigger build workflow
        if: steps.compare.outputs.version_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-and-tag.yml',
              ref: 'main'
            });
            console.log('Build workflow triggered for new Unbound version');
